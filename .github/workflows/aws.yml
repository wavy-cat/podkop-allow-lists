name: Update AWS IPs

on:
  schedule:
    - cron: '2 15 * * *'
  workflow_dispatch:

jobs:
  update-ips:
    runs-on: ubuntu-slim
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create directories
        run: mkdir -p subnets/v4 subnets/v6

      - name: Fetch and process IP ranges
        run: |
          curl -s https://ip-ranges.amazonaws.com/ip-ranges.json -o aws.json

          # Получаем список всех уникальных сервисов
          services=$(jq -r '[.prefixes[].service, .ipv6_prefixes[].service] | unique[]' aws.json)

          for service in $services; do
            # Нормализуем имя файла: нижний регистр, замена спецсимволов на подчёркивание
            filename=$(echo "$service" | tr '[:upper:]' '[:lower:]' | tr -cs 'a-z0-9' '_' | sed 's/_*$//')

            jq -r --arg svc "$service" \
              '.prefixes[] | select(.service == $svc) | .ip_prefix' \
              aws.json | sort -V > "subnets/v4/${filename}.lst"

            jq -r --arg svc "$service" \
              '.ipv6_prefixes[] | select(.service == $svc) | .ipv6_prefix' \
              aws.json | sort -V > "subnets/v6/${filename}.lst"
          done

          # Сводный список всех IPv4 и IPv6 без дублей
          jq -r '.prefixes[].ip_prefix' aws.json | sort -Vu > subnets/v4/aws_all.lst
          jq -r '.ipv6_prefixes[].ipv6_prefix' aws.json | sort -Vu > subnets/v6/aws_all.lst

          rm aws.json

      - name: Remove empty list files
        run: find subnets/ -name "*.lst" -empty -delete

      - name: Check for changes and commit
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          git add subnets/

          if git diff --staged --quiet; then
            echo "Нет изменений в подсетях. Коммит отменён."
          else
            git commit -m "chore: update AWS subnets [$(date +'%Y-%m-%d')]"
            git push
            echo "Изменения успешно закоммичены."
          fi